              
name: CI
#
# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the master branch
  push:
    branches: [ main ]

env:
  REGISTRY: "ghcr.io/pmeaney"
  IMAGE_NAME: "simple_server_express"

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo 
        uses: actions/checkout@v2
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT_3_26_23 }}

      - name: Build container image
        run: docker build -t $(echo $REGISTRY)/$(echo $IMAGE_NAME):$(echo $GITHUB_SHA) .

      - name: Push image to Container Registry
        run: docker push $(echo $REGISTRY)/$(echo $IMAGE_NAME):$(echo $GITHUB_SHA)
  
  login_and_pull:
    needs: build_and_publish
    runs-on: ubuntu-latest
    steps:
    - name: Configure SSH so it can be used to login on each subsequent command
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIV_KEY" > ~/.ssh/id_ed25519_nopass_3_26_23
          chmod 600 ~/.ssh/id_ed25519_nopass_3_26_23
          ssh -vvv -o StrictHostKeyChecking=no -i "$SSH_PUB_KEY" "$SSH_USER"@"$SSH_SERVER_IP" uptime
          ssh -vvv ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SERVER_IP }} -i ~/.ssh/id_ed25519_nopass_3_26_23 'cat /etc/os-release'
        env:
          SSH_USER: ${{ secrets.DEV_SSH_USER }}
          SSH_SERVER_IP: ${{ secrets.DEV_SERVER_IP }}
          SSH_PRIV_KEY: ${{ secrets.DEV_KEY_PRIVKEY_NOPASS_3_26_23 }}
          SSH_PUB_KEY: ${{ secrets.DEV_KEY_PUBKEY_NOPASS_3_26_23 }}
          SSH_HOST: ${{ secrets.DEV_SSH_HOST }}
          TEST_ITEM: "Hello123"

      # - name: Configure SSH so it can be used to login on each subsequent command
      #   run: |
      #     mkdir -p ~/.ssh/
      #     echo Test job-step env access: "$TEST_ITEM"
      #     ssh -vvv -o StrictHostKeyChecking=no -i "$SSH_PUB_KEY" "$SSH_USER"@"$SSH_SERVER_IP" uptime
      #     echo "$SSH_PRIV_KEY" > ~/.ssh/id_ed25519_nopass_3_26_23
      #     chmod 600 ~/.ssh/id_ed25519_nopass_3_26_23
      #     cat >>~/.ssh/config <<END
      #     Host dev
      #       HostName $SSH_HOST
      #       User $SSH_USER
      #       IdentityFile ~/.ssh/id_ed25519_nopass_3_26_23
      #       StrictHostKeyChecking no
      #     END
      #   env:
      #     SSH_USER: ${{ secrets.DEV_SSH_USER }}
      #     SSH_SERVER_IP: ${{ secrets.DEV_SERVER_IP }}
      #     SSH_PRIV_KEY: ${{ secrets.DEV_KEY_PRIVKEY_NOPASS_3_26_23 }}
      #     SSH_PUB_KEY: ${{ secrets.DEV_KEY_PUBKEY_NOPASS_3_26_23 }}
      #     SSH_HOST: ${{ secrets.DEV_SSH_HOST }}
      #     TEST_ITEM: "Hello123"
      # - name: Test echo from the server
      #   run:  ssh -vvv ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SERVER_IP }} -i ~/.ssh/id_ed25519_nopass_3_26_23 'cat /etc/os-release'